// @flow
const { Resolver } = require("@parcel/plugin");
const path = require("path");

module.exports = new Resolver({
  async resolve({ dependency, options }) {
    let { outputFS: fs, projectRoot } = options;
    if (dependency.sourcePath != null) {
      let configPath = path.join(projectRoot, ".resolverrc");
      if (await fs.exists(configPath)) {
        return {
          filePath: path.join(
            projectRoot,
            await fs.readFile(configPath, "utf8")
          ),
          fileUpdateInvalidations: new Set([configPath]),
          fileDeletionInvalidations: new Set([configPath]),
        };
      } else {
        return {
          filePath: path.join(projectRoot, "a.js"),
          fileCreationInvalidations: new Set([configPath]),
        };
      }
    } else {
      return {
        filePath: dependency.moduleSpecifier,
      };
    }
  },
});
